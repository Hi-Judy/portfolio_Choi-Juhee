<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egov.mes.manufacture.command.dao.ManCommandMapper">

<!-- 자재에서 생산지시디테일 번호 넣기 -->
<select id="selectResSeq" resultType="string">
	select nvl(max(COM_NO_DETAIL),0) as comNoDetail from manufacture_command_d
</select>


<!-- 생산지시번호 시퀀스 -->
<select id="selectSeq" resultType="string">
	select 'C'||to_Char(Sysdate, 'yyMMdd') || (lpad('001'+1,3,'0')) as comCode from dual
</select>


<!-- 생산 지시서 저장 => 계획디테일 테이블에 '생산지시중'으로 변경 -->
<update id="updatePlanStatus" parameterType="egov.mes.manufacture.command.dao.ManCommandMapper">
	update manufacture_plan_d 
	set plan_etc = '생산지시중' 
	where plan_no_detail = #{planNoDetail}
</update>


<!-- 생산 지시서 저장 => 자재 테이블에 출고량, 생산지시디테일 번호 넣어주기 -->
<insert id="insertRes" parameterType="egov.mes.manufacture.command.dao.ManCommandMapper">
	insert into resource_store(store_no, 
							   rsc_lot, 
							   ost_cnt, 
							   store_etc)
    values( ( to_char(SYSDATE,'"RO"YYMMDD""') || LPAD(RONUMBER.nextval,3,'0') ),
            #{rscLot},
            #{ostCnt},
            #{comNoDetail} 
     )
</insert>


<!-- 생산 지시 테이블 insert -->
<insert id="insertCommand" parameterType="egov.mes.manufacture.command.dao.ManCommandMapper">
	insert into manufacture_command (COM_CODE, 
									 MAN_PLAN_NO, 
									 COM_DATE, 
									 COM_NAME) 
	values ( (select SUBSTR(max(com_code),0,7) || LPAD(SUBSTR(max(com_code),8,10)+1, 3, 0) from manufacture_command),
			 #{manPlanNo},
			 #{comDate},
			 #{comName}	
	)
</insert>


<!-- 생산 지시 디테일 테이블 insert -->
<insert id="insertCommandDetail" parameterType="egov.mes.manufacture.command.dao.ManCommandMapper">
	insert into manufacture_command_d (COM_NO_DETAIL, 
									   COM_CODE, 
									   PODT_CODE, 
									   MAN_STARTDATE, 
									   MAN_GOALPERDAY,
									   ORD_QNT,
									   ORD_DUEDATE,
									   MAN_ETC)
	values ( (select nvl(max(COM_NO_DETAIL),0)+1 from manufacture_command_d),
			 (select SUBSTR(max(com_code),0,7) || LPAD(SUBSTR(max(com_code),8,10), 3, 0) from manufacture_command),
			 #{podtCode},
			 #{manStartDate},
			 #{manGoalPerday},
			 #{ordQnt},
			 to_date(#{ordDuedate},'YYYY-MM-DD HH24:MI:SS'),
			 #{manEtc}
	)	
</insert>


<!-- 이전 생산지시 조회 -->
<select id="selectPreCommand" resultType="egov.mes.manufacture.command.dao.ManCommandVO">
	select a.podt_code, prod_detail(a.podt_code) podtName, a.ord_qnt, a.ord_duedate, 
	          a.man_goalperday, a.man_startdate, a.man_etc,
	          b.plan_period, b.man_perday, b.plan_etc       
	from man_command_view a left join manufacture_plan_d b
	on a.podt_code = b.podt_code
	where a.podt_code = #{podtCode}
	or b.plan_etc = '생산지시중'
</select>


<!-- 자재코드에 해당하는 자재LOT 조회 -->
<select id="selectResLot" resultType="egov.mes.manufacture.command.dao.ManCommandVO">
	select rsc_code as resCode, rsc_lot,ist_cnt, ost_cnt
	from resource_store
	where rsc_code = #{resCode}
</select>


<!-- 제품 만드는데 필요한 공정에 해당하는 설비 조회 -->
<select id="selectFac" resultType="egov.mes.manufacture.command.dao.ManCommandVO">
	select c.podt_code, c.proc_code, prod_detail(c.proc_code) as procName,
	       d.fac_no, d.fac_code, prod_detail(d.fac_code) facName, d.fac_status, d.fac_output/d.fac_runtime*24 outputDay
	from process_flowInfo c left join (select a.fac_no, a.fac_code, prod_detail(a.fac_code), a.fac_status,
	                                          b.proc_code, a.fac_output , a.fac_runtime
	                                   from facility_status a join facility_process b
	                                   on a.fac_no = b.fac_no ) d 
	on c.proc_code = d.proc_code
	where c.podt_code = #{podtCode}
</select>


<!-- 제품 코드 입력했을 때 필요한 공정별 자재 조회 -->
<select id="selectRes" resultType="egov.mes.manufacture.command.dao.ManCommandVO">
	select podt_code, prod_detail(podt_code) podtName, res_code, res_usage, 
	proc_code, prod_detail(proc_code) ProcName
	from prdt_bom_res
	where podt_code= #{podtCode}
	order by proc_code
</select>


<!-- 지시가 없는 생산계획 디테일 조회 (생산지시서 관리 페이지) -->
<select id="selectManPlan" resultType="egov.mes.manufacture.command.dao.ManCommandVO">
	select a.podt_code, prod_detail(a.podt_code) podtName, a.man_plan_name, 
		   a.man_plan_date, a.plan_no_detail, a.man_plan_no, a.plan_etc
	from man_plan_view a left outer join manufacture_command b
	on a.man_plan_no = b.man_plan_no
	where b.com_name is null
	and a.plan_etc ='계획완료'
	or a.plan_etc = '생산지시중'
	
		<if test = "planFromDate != null"> 
			and to_char(a.man_plan_date, 'rrrr-MM-dd') >= #{planFromDate}
		</if>
		<if test= "planToDate != null">
			and #{planToDate} >=  to_char(a.man_plan_date, 'rrrr-MM-dd')
		</if>

	order by a.man_plan_no
</select>


<!-- 생산계획 디테일 상세 조회(생산지시서 관리 페이지) -->
<select id="selectManPlanDetail" resultType="egov.mes.manufacture.command.dao.ManCommandVO">
	select a.podt_code,  a.ord_duedate,
	       b.plan_no_detail, b.podt_code, prod_detail(b.podt_code) podtName, b.ord_qnt, b.plan_period, b.man_plan_no,
	       (select man_perday from manufacture_plan_d where podt_code = a.podt_code) as manPerday
	from ord_detail_view a join manufacture_plan_d b
	on a.podt_code = b.podt_code
	where b.plan_no_detail = #{planNoDetail}
</select>


</mapper>