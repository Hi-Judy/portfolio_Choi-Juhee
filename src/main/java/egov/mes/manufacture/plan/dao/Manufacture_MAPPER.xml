<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egov.mes.manufacture.plan.dao.ManufactureMapper">

<!-- 생산계획서 디테일 조회(생산계획서 조회 페이지) -->
<select id="selectManufactureDetail" resultType="egov.mes.manufacture.plan.dao.ManufacturePlanVO">
	select a.man_plan_no, a.man_plan_date, a.man_plan_name, 
		   a.podt_code, prod_detail(a.podt_code) podtName,
	       a.plan_period, a.man_perday, a.plan_startdate, a.plan_etc,
	       b.ord_code, b.ord_duedate
	from man_plan_view a join order_management b
	on a.ord_code = b.ord_code
	where a.man_plan_no = #{manPlanNo}
	and a.podt_code = #{podtCode}
</select>


<!-- 생산계획서 조회(생산계획서 조회 페이지) -->
<select id="selectManufacturePlan" resultType="egov.mes.manufacture.plan.dao.ManufacturePlanVO">
	select  a.podt_code, prod_detail(a.podt_code) podtName, 
			b.ord_code, b.man_plan_no, b.man_plan_name, b.man_plan_date
	from trade_info a join manufacture_plan b
	on a.ord_code = b.ord_code
	where 1=1
	
	<if test = ' podtCode != null and podtCode != "" '>
		and a.podt_code = #{podtCode}
	</if>
	
	<if test = ' manPlanDate != null and manPlanDate != "" '>
		and b.man_plan_date = #{manPlanDate}
	</if>
	
	order by a.podt_code
</select>


<!-- 조회된 생산계획서 삭제. (생산디테일 삭제) -->
<delete id="deletePlan" parameterType="egov.mes.manufacture.plan.dao.ManufacturePlanVO">
	delete 
	from manufacture_plan_d
	where man_plan_no = #{manPlanNo}
</delete>


<!-- 생산계획 데이터 추가 -->
<insert id="insertPlan" parameterType="egov.mes.manufacture.plan.dao.ManufacturePlanVO">
	insert into manufacture_plan ( MAN_PLAN_NO,
								   ORD_CODE,
								   CUS_CODE,
								   MAN_PLAN_NAME,
								   MAN_PLAN_DATE )
	values( f_code_maker('P'),
			#{ordCode},
			(select cus_code from order_management where ord_code = #{ordCode}),
			#{manPlanName},
			#{manPlanDate} )	
</insert>


<!-- 생산계획 디테일 데이터 추가 -->
<insert id="insertPlanDetail" statementType="CALLABLE">
		insert into manufacture_plan_d ( PLAN_NO_DETAIL,
										 PODT_CODE,
										 MAN_PLAN_NO,
										 PLAN_STARTDATE,
										 PLAN_PERIOD,
										 MAN_PERDAY,
										 PLAN_ETC,
										 ORD_QNT,
										 PLAN_COMPLETE )
		values( (select nvl(max(PLAN_NO_DETAIL),0)+1 from manufacture_plan_d),
				#{podtCode},
				(select nvl(max(MAN_PLAN_NO),0) from manufacture_plan),
				#{planStartDate},
				to_date(#{planComplete}, 'yyyy-MM-dd') - to_date(#{planStartDate},'yyyy-MM-dd') + 1 ,
				#{manPerday},
				'계획완료',
				#{ordQnt},
				#{planComplete} )
</insert>


<!-- 계획서 추가 후 주문 상태 '진행'으로 변경 -->
<update id = "updateOrdStatus" parameterType="egov.mes.manufacture.plan.dao.ManufacturePlanVO">
	update order_management
	set ord_status = '진행중'
	where ord_code = #{ordCode}
</update>


<!-- 생산계획 조회 -->
<select id = "selectManPlan" resultType="egov.mes.manufacture.plan.dao.ManufacturePlanVO">
	select a.man_plan_no, a.man_plan_name, a.man_plan_date, 
		   a.podt_code, prod_detail(a.podt_code) podtName
	from man_plan_view a join order_management b
    on a.ord_code = b.ord_code
	where b.ord_status = '진행중'
		<if test = "startDate != null"> 
			and to_char(a.man_plan_date, 'rrrr-MM-dd') >= #{startDate}
		</if>
		<if test= "endDate != null">
			and #{endDate} >=  to_char(a.man_plan_date, 'rrrr-MM-dd')
		</if>
	order by a.man_plan_no
</select>


<!-- 생산계획 디테일 조회 -->
<select id="selectManPlanDetail" resultType="egov.mes.manufacture.plan.dao.ManufacturePlanVO">
	select a.man_plan_no, a.podt_code, prod_detail(a.podt_code) podtName, a.man_plan_date,
		   a.plan_startdate, a.plan_period, a.plan_etc, a.plan_complete, 
		   (select min(d.output_of_day)
		    from process_flowInfo c join ( select a.fac_no, a.fac_code, a.fac_output/a.fac_runtime*24 as output_of_day,
                                                                        b.proc_code
                                           from facility_status a join facility_process b
                                           on a.fac_no = b.fac_no
                                           where a.fac_status='Y') d
			on c.proc_code = d.proc_code
			where podt_code = a.podt_code) as manPerday,
          b.ord_code, b.ord_status, b.ord_duedate, b.ord_qnt
	from man_plan_view a left join ord_detail_view b
	on a.podt_code = b.podt_code
	where a.man_plan_no = #{manPlanNo}
    and a.ord_code = b.ord_code
    and a.podt_code = #{podtCode}
	order by a.man_plan_no
</select>


<!-- 자재 조회 -->
<select id="selectRes" resultType="egov.mes.manufacture.plan.dao.ManufacturePlanVO">

select a.podt_code, prod_detail(a.podt_code) podtName, a.res_usage, 
	   b.rsc_code, sum(b.rsc_cnt) as rscCnt
from prdt_bom_res a join r_qnt b
on a.res_code = b.rsc_code
where a.podt_code = #{podtCode}
group by a.podt_code, a.res_usage,  b.rsc_code
order by b.rsc_code

</select>


<!-- 미계획 내역 조회 -->
<select id="selectPlan" resultType="egov.mes.manufacture.plan.dao.ManufacturePlanVO">
	select a.ord_code, a.ord_duedate, a.ord_status, a.cus_code, 
		   a.ord_qnt, a.podt_code, b.code_name podtName
    from ord_detail_view a join common_code b
    on a.podt_code = b.code
    where a.ord_status = '미진행'
    AND substr(ord_date,0,5) = '22/01'
    order by a.ord_code
</select>


<!-- 미계획 내역 메인화면에 넣어주기 -->
<select id="selectPlanToMain" resultType="egov.mes.manufacture.plan.dao.ManufacturePlanVO">
	select ord_code, ord_qnt, ord_duedate, ord_status, podt_code, prod_detail(podt_code) podtName,
	(select min(d.output_of_day)
		     from process_flowInfo c join ( select a.fac_no, a.fac_code, a.fac_output/a.fac_runtime*24 as output_of_day,
                                                        b.proc_code
                                              from facility_status a join facility_process b
                                              on a.fac_no = b.fac_no
                                              where a.fac_status='Y') d
			 on c.proc_code = d.proc_code
			 where c.podt_code = #{podtCode}) as manPerday
	from ord_detail_view 
	where ord_status = '미진행'
	and ord_code = #{ordCode}
</select>

<!-- 달력용 -->
<select id="selectCal" resultType="egov.mes.manufacture.plan.dao.ManufacturePlanVO">
	select com_code , to_char(man_startdate,'yyyy-MM-dd') as manStartdate , to_char(ord_duedate,'yyyy-MM-dd') as ordDuedate from manufacture_command_d 
</select>
</mapper>